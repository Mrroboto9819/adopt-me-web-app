name: Front - Build & Deploy (Local Docker)

on:
  push:
    branches: ["develop"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH (local Docker build)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e

            cd ${{ secrets.APP_PATH }}

            echo "Pulling latest code..."
            git fetch origin develop
            git checkout develop
            git reset --hard origin/develop
            git clean -fd

            echo "Building containers..."
            docker compose -f docker-compose.yml build

            echo "Restarting containers..."
            docker compose -f docker-compose.yml up -d

            echo "Cleaning unused images..."
            docker image prune -f

  notify:
    name: Discord notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send Discord webhook
        env:
          WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
          RESULT: ${{ needs.deploy.result }}
          BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          APP_URL: ${{ secrets.PUBLIC_APP_URL }}
        run: |
          # Skip if no webhook configured
          if [ -z "$WEBHOOK" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi

          RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          REPO_URL="https://github.com/${REPO}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          # Escape commit message for JSON
          SAFE_MSG=$(echo "$COMMIT_MSG" | head -1 | sed 's/"/\\"/g' | cut -c1-100)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [ "$RESULT" = "success" ]; then
            COLOR=3066993   # green
            STATUS="‚úÖ Deploy Successful"
            DESC="AdoptMe web app deployed to production"
          else
            COLOR=15158332  # red
            STATUS="‚ùå Deploy Failed"
            DESC="Deployment failed - check logs for details"
          fi

          jq -n \
            --arg title "$STATUS" \
            --arg desc "$DESC" \
            --arg branch "$BRANCH" \
            --arg commit "$SHORT_SHA" \
            --arg commit_url "$COMMIT_URL" \
            --arg commit_msg "$SAFE_MSG" \
            --arg author "$COMMIT_AUTHOR" \
            --arg run "$RUN_URL" \
            --arg repo "$REPO_URL" \
            --arg app_url "$APP_URL" \
            --arg timestamp "$TIMESTAMP" \
            --argjson color $COLOR \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                fields: [
                  {name: "üåø Branch", value: $branch, inline: true},
                  {name: "üîó Commit", value: "[\($commit)](\($commit_url))", inline: true},
                  {name: "üë§ Author", value: $author, inline: true},
                  {name: "üìù Message", value: $commit_msg, inline: false},
                  {name: "üåê View App", value: $app_url, inline: false},
                  {name: "üîß Actions", value: "[View Logs](\($run))", inline: true},
                  {name: "üì¶ Repository", value: "[AdoptMe](\($repo))", inline: true}
                ],
                footer: {text: "AdoptMe Web App"},
                timestamp: $timestamp
              }]
            }' \
          | curl -H "Content-Type: application/json" -d @- "$WEBHOOK"
